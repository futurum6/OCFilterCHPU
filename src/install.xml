<?xml version="1.0" encoding="utf-8"?>
<modification>
    <name>OCFilterCHPU</name>
    <code>ocfilter_chpu</code>
    <version>1.0.0</version>
    <author>futurum6</author>
    <link>https://github.com/futurum6</link>

    <!-- Add OCFilter CHPU URL processing for incoming URLs -->
    <file path="catalog/controller/startup/seo_url.php">
        <operation>
            <search><![CDATA[public function index() {]]></search>
            <add position="after"><![CDATA[
        // OCFilter CHPU URL processing
        if ($this->config->get('ocfilter_chpu_status')) {
            try {
                require_once(DIR_SYSTEM . 'library/ocfilter_chpu.php');
                $ocfilter_chpu = new OCFilterCHPU($this->registry);
                if ($ocfilter_chpu && method_exists($ocfilter_chpu, 'processIncomingUrl')) {
                    $ocfilter_chpu->processIncomingUrl();
                }
            } catch (Exception $e) {
                error_log('OCFilterCHPU error: ' . $e->getMessage());
            }
        }]]></add>
        </operation>
    </file>
    
    <!-- Add CHPU URL generation for outgoing links -->
    <file path="system/library/url.php">
        <operation>
            <search><![CDATA[public function link($route, $args = '', $connection = 'NONSSL') {]]></search>
            <add position="after"><![CDATA[
        // OCFilter CHPU URL conversion for outgoing links
        if (isset($this->registry) && $this->registry->get('config')->get('ocfilter_chpu_status') && strpos($args, 'ocf=') !== false) {
            try {
                require_once(DIR_SYSTEM . 'library/ocfilter_chpu.php');
                $ocfilter_chpu = new OCFilterCHPU($this->registry);
                if ($ocfilter_chpu && method_exists($ocfilter_chpu, 'convertUrlArgs')) {
                    $args = $ocfilter_chpu->convertUrlArgs($route, $args);
                }
            } catch (Exception $e) {
                error_log('OCFilterCHPU URL conversion error: ' . $e->getMessage());
            }
        }]]></add> 
        </operation>
    </file>
</modification>